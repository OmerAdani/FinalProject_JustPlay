<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ניהול מגרשים</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      body {
        background-color: #cce7ff;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
      }
      .header {
        background-color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: bold;
        color: #333;
        text-align: center;
        width: 100%;
      }
      .back-button {
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 18px;
        cursor: pointer;
      }
      .container {
        background-color: white;
        margin: 40px auto;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        width: 95%;
        max-width: 700px;
      }
      label {
        font-weight: bold;
      }
      .form-control {
        margin-bottom: 15px;
      }
      .field {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 10px;
        width: 100%;
        height: 300px;
        margin-top: 20px;
      }
      .quarter {
        border: 2px solid #333;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border-radius: 8px;
        transition: 0.3s;
        font-size: 18px;
        text-align: center;
        white-space: pre-line;
        color: #000;
        background-color: #d4edda;
        cursor: pointer;
      }
      .quarter.selected {
        background-color: #4caf50;
        color: white;
      }
      .quarter.booked-other {
        background-color: #f8d7da;
        color: #721c24;
        cursor: not-allowed;
      }
      .btn-primary {
        width: 100%;
        font-weight: bold;
        margin-top: 20px;
      }
      #output {
        margin-top: 15px;
        font-size: 14px;
      }
      table {
        width: 100%;
        margin-top: 30px;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 10px;
        border: 1px solid #ccc;
        text-align: center;
      }
      th {
        background-color: #007bff;
        color: white;
      }
      #authorize_button {
        background-color: #007bff;
      }
      #output {
        margin-top: 15px;
        font-size: 15px;
        background-color: #e2f0ff;
        border: 1px solid #a8cfff;
        padding: 12px 18px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        color: #004085;
        direction: rtl;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h2>ניהול מגרשים</h2>
      <button class="back-button" onclick="goHome()">🏠</button>
    </div>
    <div class="container">
      <div style="margin-bottom: 30px">
        <img
          src="../images/logo.jpg"
          alt="JUST PLAY"
          style="width: 180px; display: block; margin: 0 auto"
        />
      </div>
      <button
        id="authorize_button"
        class="btn btn-success mb-4"
        style="display: none"
        onclick="handleAuthClick()"
      >
        התחבר וטען לוח שנה
      </button>
      <div class="mb-3">
        <label for="coach" class="form-label">שם מאמן:</label>
        <input type="text" id="coach" class="form-control" disabled />
      </div>
      <label for="date">תאריך:</label>
      <input type="date" id="date" class="form-control" required />
      <label for="startTime">שעת התחלה:</label>
      <input type="time" id="startTime" class="form-control" required />
      <label for="endTime">שעת סיום:</label>
      <input type="time" id="endTime" class="form-control" required />
      <div class="field" id="field">
        <div class="quarter" data-quarter="1">רבע 1</div>
        <div class="quarter" data-quarter="2">רבע 2</div>
        <div class="quarter" data-quarter="3">רבע 3</div>
        <div class="quarter" data-quarter="4">רבע 4</div>
      </div>
      <button
        class="btn btn-primary"
        id="bookFieldButton"
        onclick="bookField()"
        disabled
      >
        שריין מגרש
      </button>
      <div id="output"></div>
      <h4 class="mt-5">לוח זמנים של המגרש</h4>
      <table id="bookingTable">
        <thead>
          <tr>
            <th>תאריך</th>
            <th>משעה</th>
            <th>עד שעה</th>
            <th>רבעים</th>
            <th>מאמן</th>
            <th>מחק</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      const SHARED_CALENDAR_ID = "itayJustplay@gmail.com";
      const CLIENT_ID =
        "";
      const API_KEY = "";
      const DISCOVERY_DOCS = [
        "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
      ];
      const SCOPES = "https://www.googleapis.com/auth/calendar.events";
      const TIMEZONE = "Europe/Helsinki";

      const bookings = {};
      let calendarEventIds = {};

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      function goHome() {
        window.location.href = "home.html";
      }

      function timesOverlap(start1, end1, start2, end2) {
        return start1 < end2 && start2 < end1;
      }

      function createGoogleCalendarEvent(
        date,
        startTime,
        endTime,
        coach,
        quarters
      ) {
        const event = {
          summary: `${coach} - ${quarters.map((q) => "רבע " + q).join(", ")}`,
          description: `רבעים: ${quarters.join(", ")}`,
          start: { dateTime: `${date}T${startTime}:00`, timeZone: TIMEZONE },
          end: { dateTime: `${date}T${endTime}:00`, timeZone: TIMEZONE },
        };
        gapi.client.calendar.events
          .insert({
            calendarId: SHARED_CALENDAR_ID,
            resource: event,
          })
          .then((res) => {
            document.getElementById(
              "output"
            ).innerHTML = `האירוע נוסף ללוח השנה: <a href="${res.result.htmlLink}" target="_blank">צפה באירוע</a>`;
            const eventId = res.result.id;
            const dateTime = `${date} ${startTime}-${endTime}`;
            bookings[dateTime] = { quarters: quarters, coach, eventId };
            calendarEventIds[dateTime] = eventId;
            renderBookingTable();
            updateUI();
          })
          .catch(() => {
            alert("שגיאה בהוספת האירוע ליומן.");
          });
      }

      function deleteGoogleCalendarEvent(eventId, cb) {
        gapi.client.calendar.events
          .delete({
            calendarId: SHARED_CALENDAR_ID,
            eventId: eventId,
          })
          .then(() => {
            if (cb) cb();
          })
          .catch(() => {
            alert("מחיקת האירוע מלוח השנה נכשלה.");
          });
      }

      function renderBookingTable() {
        const tbody = document.querySelector("#bookingTable tbody");
        tbody.innerHTML = "";
        for (const key in bookings) {
          const [date, timeRange] = key.split(" ");
          const [startTime, endTime] = timeRange.split("-");
          const coach = bookings[key].coach;
          const quartersDisplay = bookings[key].quarters.join(", ");
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${date}</td>
            <td>${startTime}</td>
            <td>${endTime}</td>
            <td>${quartersDisplay}</td>
            <td>${coach}</td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteFullBooking('${key}')">מחק</button></td>
          `;
          tbody.appendChild(row);
        }
      }

      function deleteFullBooking(key) {
        const eventId = bookings[key].eventId;
        if (eventId) {
          deleteGoogleCalendarEvent(eventId, () => {
            delete bookings[key];
            delete calendarEventIds[key];
            renderBookingTable();
            updateUI();
          });
        }
      }

      function updateUI() {
        document.querySelectorAll(".quarter").forEach((q) => {
          q.className = "quarter";
          q.innerText = `רבע ${q.dataset.quarter}`;
        });

        const date = document.getElementById("date").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;
        if (!date || !startTime || !endTime) return;

        const start = new Date(`${date}T${startTime}`);
        const end = new Date(`${date}T${endTime}`);

        for (const key in bookings) {
          const [bDate, bTime] = key.split(" ");
          const [bStart, bEnd] = bTime.split("-");
          const bookingStart = new Date(`${bDate}T${bStart}`);
          const bookingEnd = new Date(`${bDate}T${bEnd}`);
          if (
            bDate === date &&
            timesOverlap(start, end, bookingStart, bookingEnd)
          ) {
            bookings[key].quarters.forEach((qNum) => {
              const el = document.querySelector(
                `.quarter[data-quarter="${qNum}"]`
              );
              if (el) {
                el.classList.add("booked-other");
                el.innerText = `רבע ${qNum}\n${bookings[key].coach}`;
              }
            });
          }
        }
      }

      function bookField() {
        const coach = localStorage.getItem("loggedInUserName") || "לא ידוע";
        document.getElementById("coach").value = coach;
        const date = document.getElementById("date").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;

        const selectedQuarters = Array.from(
          document.querySelectorAll(".quarter.selected")
        ).map((q) => q.dataset.quarter);

        if (
          !coach ||
          !date ||
          !startTime ||
          !endTime ||
          selectedQuarters.length === 0
        ) {
          alert("אנא מלא את כל השדות ובחר רבעים.");
          return;
        }

        for (const key in bookings) {
          const [bDate, bTime] = key.split(" ");
          const [bStart, bEnd] = bTime.split("-");
          const bookingStart = new Date(`${bDate}T${bStart}`);
          const bookingEnd = new Date(`${bDate}T${bEnd}`);
          const start = new Date(`${date}T${startTime}`);
          const end = new Date(`${date}T${endTime}`);
          if (
            bDate === date &&
            timesOverlap(start, end, bookingStart, bookingEnd)
          ) {
            const overlapping = bookings[key].quarters.filter((q) =>
              selectedQuarters.includes(q)
            );
            if (overlapping.length > 0) {
              alert("חלק מהרבעים שנבחרו כבר תפוסים.");
              return;
            }
          }
        }

        createGoogleCalendarEvent(
          date,
          startTime,
          endTime,
          coach,
          selectedQuarters
        );
      }

      function gapiLoaded() {
        gapi.load("client", initializeGapiClient);
      }
      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        maybeEnableAuth();
      }
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (tokenResponse) => {
            gapi.client.setToken({ access_token: tokenResponse.access_token });
            document.getElementById("bookFieldButton").disabled = false;
            document.getElementById("authorize_button").style.display = "none";
            loadBookingsFromGoogleCalendar();
          },
        });
        gisInited = true;
        maybeEnableAuth();
      }
      function maybeEnableAuth() {
        if (gapiInited && gisInited) {
          document.getElementById("authorize_button").style.display = "block";
        }
      }
      function handleAuthClick() {
        tokenClient.requestAccessToken();
      }

      function loadBookingsFromGoogleCalendar() {
        gapi.client.calendar.events
          .list({
            calendarId: SHARED_CALENDAR_ID,
            timeMin: new Date().toISOString(),
            showDeleted: false,
            singleEvents: true,
            maxResults: 100,
            orderBy: "startTime",
          })
          .then((response) => {
            response.result.items.forEach((event) => {
              if (!event.start.dateTime) return;
              const date = event.start.dateTime.substring(0, 10);
              const startTime = event.start.dateTime.substring(11, 16);
              const endTime = event.end.dateTime.substring(11, 16);
              const key = `${date} ${startTime}-${endTime}`;
              const quarters =
                event.description?.replace("רבעים: ", "").split(", ") || [];
              const coach = event.summary.split(" - ")[0];
              bookings[key] = { quarters, coach, eventId: event.id };
              calendarEventIds[key] = event.id;
            });
            renderBookingTable();
            updateUI();
          });
      }

      window.onload = function () {
        document.getElementById("coach").value =
          localStorage.getItem("loggedInUserName") || "";
        window.gapiLoaded = gapiLoaded;
        window.gisLoaded = gisLoaded;
        const script = document.createElement("script");
        script.src = "https://apis.google.com/js/api.js?onload=gapiLoaded";
        document.head.appendChild(script);
        const script2 = document.createElement("script");
        script2.src = "https://accounts.google.com/gsi/client";
        script2.onload = gisLoaded;
        document.head.appendChild(script2);
        document.querySelectorAll(".quarter").forEach((q) =>
          q.addEventListener("click", () => {
            if (!q.classList.contains("booked-other")) {
              q.classList.toggle("selected");
            }
          })
        );
        ["date", "startTime", "endTime"].forEach((id) =>
          document.getElementById(id).addEventListener("change", updateUI)
        );
      };
    </script>
  </body>
</html>
