<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>שליחת הודעה לשחקנים</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
      rel="stylesheet"
    />

    <script>
      (function () {
        emailjs.init("SCFo7hik57a8-ZKll");
      })();
    </script>
    <style>
      body {
        background-color: #cce7ff;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .header {
        background-color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .header h3 {
        margin: 0;
        font-size: 24px;
        color: #333;
        text-align: center;
        width: 100%;
      }

      .back-button {
        background-color: #5c636a;
        border: none;
        border-radius: 50%;
        width: 42px;
        height: 42px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .back-button:hover {
        background-color: #444;
      }

      .container {
        background-color: white;
        margin: 30px auto;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        width: 95%;
        max-width: 650px;
      }

      .player-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 8px;
        background: #f9f9f9;
      }

      #loadingSpinner {
        display: none;
        text-align: center;
        margin-top: 15px;
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
          padding: 15px;
        }

        .header h3 {
          font-size: 20px;
          text-align: center;
          width: 100%;
        }

        .back-button {
          width: 36px;
          height: 36px;
          font-size: 16px;
        }

        .container {
          width: 100% !important;
          max-width: 100% !important;
          padding: 20px 16px !important;
          margin: 20px auto !important;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn {
          font-size: 14px;
          padding: 10px 12px;
        }

        #toggleAllBtn {
          font-size: 13px;
          padding: 6px 10px;
        }

        .player-list {
          max-height: 250px;
          font-size: 14px;
        }

        input,
        textarea {
          font-size: 16px;
          width: 100% !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h3>שליחת הודעה לשחקנים</h3>
      <button class="back-button" onclick="goHome()" title="חזור לדף הבית">
        🏠
      </button>
    </div>

    <div class="container">
      <form id="emailForm">
        <div class="mb-3">
          <label for="emailSubject" class="form-label">נושא ההודעה</label>
          <input type="text" class="form-control" id="emailSubject" required />
        </div>
        <div class="mb-3">
          <label for="emailBody" class="form-label">תוכן ההודעה</label>
          <textarea
            class="form-control"
            id="emailBody"
            rows="6"
            required
          ></textarea>
        </div>

        <div class="mb-3 d-flex justify-content-between align-items-center">
          <label class="form-label">בחר שחקנים:</label>
          <button
            type="button"
            class="btn btn-sm btn-outline-primary"
            id="toggleAllBtn"
          >
            בחר הכול
          </button>
        </div>
        <div id="playerList" class="player-list"></div>

        <button type="submit" class="btn btn-primary w-100 mt-3">
          שלח הודעה לנבחרים
        </button>
        <div id="loadingSpinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">טוען...</span>
          </div>
          <p>שולח הודעות...</p>
        </div>
      </form>
    </div>

    <script>
      function goHome() {
        window.location.href = "home.html";
      }

      function ajaxCall(method, api, data, successCB, errorCB) {
        $.ajax({
          type: method,
          url: api,
          data: data ? JSON.stringify(data) : null,
          contentType: "application/json",
          dataType: "json",
          success: successCB,
          error: errorCB,
        });
      }

      $(document).ready(function () {
        const coachId = localStorage.getItem("loggedInUserId");
        if (!coachId) {
          Swal.fire({
            icon: "warning",
            title: "שגיאה",
            text: "לא נמצא מזהה מאמן.",
          });
          return;
        }

        const apiUrl = `https://proj.ruppin.ac.il/igroup8/test2/tar1/api/Player/GetPlayerbyCoachID/${coachId}`;

        ajaxCall(
          "GET",
          apiUrl,
          null,
          function (players) {
            const listContainer = $("#playerList");
            players.forEach((player, index) => {
              const checkbox = `
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="player${index}" value="${player.email}">
                <label class="form-check-label" for="player${index}">${player.name} (${player.email})</label>
              </div>`;
              listContainer.append(checkbox);
            });
          },
          function (err) {
            Swal.fire({
              icon: "error",
              title: "שגיאה",
              text: "שגיאה בטעינת רשימת השחקנים.",
            });
            console.error(err);
          }
        );
      });

      let allSelected = false;
      $("#toggleAllBtn").click(function () {
        allSelected = !allSelected;
        $("#playerList input[type='checkbox']").prop("checked", allSelected);
        $(this).text(allSelected ? "בטל הכול" : "בחר הכול");
      });

      $("#emailForm").on("submit", function (e) {
        e.preventDefault();

        const subject = $("#emailSubject").val().trim();
        const message = $("#emailBody").val().trim();
        const senderEmail = localStorage.getItem("loggedInUserEmail");
        const senderName = localStorage.getItem("loggedInUserName");

        const selectedEmails = $("#playerList input:checked")
          .map(function () {
            return this.value;
          })
          .get();

        if (!senderEmail || !senderName) {
          Swal.fire({
            icon: "error",
            title: "שגיאה",
            text: "פרטי המאמן חסרים.",
          });
          return;
        }

        if (selectedEmails.length === 0) {
          Swal.fire({
            icon: "warning",
            title: "שים לב",
            text: "בחר לפחות שחקן אחד לשליחה.",
          });
          return;
        }

        $("#loadingSpinner").show();

        let sentCount = 0;
        selectedEmails.forEach((email) => {
          const templateParams = {
            from_name: senderName,
            from_email: senderEmail,
            to_email: email,
            bcc_email: senderEmail,
            reply_to: senderEmail,
            subject: subject,
            message: message,
          };

          emailjs
            .send("service_orcpsgo", "template_9dbbwl5", templateParams)
            .then(() => {
              sentCount++;
              if (sentCount === selectedEmails.length) {
                $("#loadingSpinner").hide();
                Swal.fire({
                  icon: "success",
                  title: "הצלחה!",
                  text: "ההודעות נשלחו בהצלחה!",
                });
                $("#emailForm")[0].reset();
                $("#playerList input[type='checkbox']").prop("checked", false);
                $("#toggleAllBtn").text("בחר הכול");
                allSelected = false;
              }
            })
            .catch((error) => {
              console.error(`שגיאה בשליחה ל-${email}:`, error);
              $("#loadingSpinner").hide();
              Swal.fire({
                icon: "error",
                title: "שגיאה בשליחה",
                text: "אירעה שגיאה בעת שליחת ההודעה.",
              });
            });
        });
      });
    </script>
  </body>
</html>
