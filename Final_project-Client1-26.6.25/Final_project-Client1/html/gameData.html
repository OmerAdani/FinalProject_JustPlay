<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>נתוני משחקים לפי שחקן</title>

    <!-- Bootstrap בלבד -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #cce7ff;
        margin: 0;
        padding: 0;
      }

      .header {
        background-color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .header h2 {
        margin: 0;
        font-size: 24px;
        color: #333;
      }

      .button-group {
        display: flex;
        gap: 10px;
      }

      .btn-custom {
        font-weight: bold;
        border-radius: 8px;
        padding: 10px 16px;
      }

      .container {
        background-color: white;
        margin: 30px auto;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        width: 95%;
      }

      #searchInput {
        margin-bottom: 20px;
        padding: 10px;
        width: 20%;
        border: 1px solid #ccc;
        border-radius: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }

      table th,
      table td {
        border: 1px solid #dee2e6;
        text-align: center;
        vertical-align: middle;
        padding: 0.75rem;
      }

      table thead th {
        background-color: #007baf;
        color: white;
        font-size: 14px;
        font-weight: bold;
      }

      .back-button {
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .btn-excel {
        background-color: #28a745;
        color: white;
      }

      .btn-insight,
      .btn-edit {
        background-color: #0dcaf0;
        color: white;
      }

      /* 💡 media query: התאמות למובייל */
      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
          padding: 15px;
        }

        .header h2 {
          font-size: 20px;
          text-align: center;
          width: 100%;
        }

        .button-group {
          flex-wrap: wrap;
          justify-content: center;
          width: 100%;
        }

        .btn-custom {
          padding: 8px 12px;
          font-size: 14px;
          margin: 5px 0;
        }

        .back-button {
          width: 36px;
          height: 36px;
          font-size: 16px;
        }

        .container {
          padding: 20px 10px;
        }

        #searchInput {
          width: 100% !important;
        }

        .table-responsive {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }

        table {
          min-width: 800px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h2>נתוני משחקים לפי שחקן</h2>
      <div class="button-group">
        <button class="btn btn-edit btn-custom" onclick="goToEdit()">
          מעבר לעריכת נתוני משחק
        </button>
        <button class="btn btn-edit btn-custom" onclick="goToCreateGame()">
          מעבר ליצירת נתוני משחק
        </button>
        <button class="btn btn-insight btn-custom" onclick="goToInsights()">
          מעבר לעמוד תובנות חכמות
        </button>
        <button class="btn btn-excel btn-custom" onclick="exportToExcel()">
          ייצוא לאקסל
        </button>
        <button class="back-button" onclick="goHome()" title="חזור לדף הבית">
          🏠
        </button>
      </div>
    </div>

    <div class="container">
      <input
        type="text"
        id="searchInput"
        placeholder="חיפוש"
        onkeyup="filterTable()"
      />

      <!-- 💡 עטיפה בגלילה -->
      <div class="table-responsive">
        <table id="gameDataTable" class="table table-bordered">
          <thead>
            <tr>
              <th>ת.ז שחקן</th>
              <th>שם שחקן</th>
              <th>תפקיד</th>
              <th>שם קבוצה</th>
              <th>יריבה</th>
              <th>תאריך משחק</th>
              <th>מזהה משחק</th>
              <th>מסירות</th>
              <th>ניסיונות הבקעה</th>
              <th>מאבקי אוויר</th>
              <th>מסירות מדויקות</th>
              <th>שערים</th>
              <th>בישולים</th>
              <th>בעיטות למסגרת</th>
              <th>איבודי כדור</th>
              <th>מסירות מפתח</th>
              <th>חילוצי כדור</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
      function goHome() {
        window.location.href = "home.html";
      }

      function goToInsights() {
        window.location.href = "Smart_Conclusions.html";
      }

      function goToEdit() {
        window.location.href = "./editGameData.html";
      }

      function goToCreateGame() {
        window.location.href = "./createGameData.html";
      }

      function formatDate(dateString) {
        const d = new Date(dateString);
        return d.toLocaleDateString("he-IL");
      }

      function ajaxCall(method, api, data, successCB, errorCB) {
        $.ajax({
          type: method,
          url: api,
          data: data,
          cache: false,
          contentType: "application/json",
          dataType: "json",
          success: successCB,
          error: errorCB,
        });
      }

      function loadGameData() {
        const coachId = localStorage.getItem("loggedInUserId");
        if (!coachId) {
          alert("לא נמצא מזהה מאמן.");
          return;
        }

        ajaxCall(
          "GET",
          `https://proj.ruppin.ac.il/igroup8/test2/tar1/api/Game_Data/by-coach/${coachId}`,
          null,
          function (data) {
            const tbody = $("#gameDataTable tbody");
            tbody.empty();

            data.forEach((item) => {
              const row = `<tr>
                <td>${item.playerId}</td>
                <td>${item.playerName}</td>
                <td>${item.playerPosition}</td>
                <td>${item.playerTeam}</td>
                <td>${item.opposing_team}</td>
                <td>${formatDate(item.gameDate)}</td>
                <td>${item.gameId}</td>
                <td>${item.totalPasses}</td>
                <td>${item.totalAttemptsToScore}</td>
                <td>${item.totalAirAttempts}</td>
                <td>${item.numOfAccuratePasses}</td>
                <td>${item.numOfGoals}</td>
                <td>${item.numOfAssists}</td>
                <td>${item.shotsOnTarget}</td>
                <td>${item.numOfLostBall}</td>
                <td>${item.keyPasses}</td>
                <td>${item.numOfBallRecoveries}</td>
              </tr>`;
              tbody.append(row);
            });
          },
          function (err) {
            alert("אירעה שגיאה בטעינת הנתונים.");
            console.error(err);
          }
        );
      }

      function exportToExcel() {
        const table = document.getElementById("gameDataTable");
        let csv = [];

        const headers = Array.from(table.querySelectorAll("thead th")).map(
          (th) => th.innerText.trim()
        );
        csv.push(headers.join(","));

        const rows = table.querySelectorAll("tbody tr");
        rows.forEach((row) => {
          const rowData = Array.from(row.querySelectorAll("td")).map((td) =>
            td.innerText.trim().replace(/,/g, " ")
          );
          csv.push(rowData.join(","));
        });

        const csvContent =
          "data:text/csv;charset=utf-8,\uFEFF" + csv.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "Player_Game_Data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function filterTable() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll("#gameDataTable tbody tr");

        rows.forEach((row) => {
          const text = row.innerText.toLowerCase();
          row.style.display = text.includes(filter) ? "" : "none";
        });
      }

      $(document).ready(function () {
        loadGameData();
      });
    </script>
  </body>
</html>
